# Agent Workspace Collaboration Protocol

## 1. 摘要

Agent Workspace Collaboration Protocol (AWCP) 是一个面向大模型多智能体协作的工作空间委派协议。它使一个本地智能体能够将指定的本地目录（workspace）以"近似远端智能体本地目录"的方式委派给远端智能体协作完成任务，并在任务结束后自动回收访问权限与挂载资源。

AWCP 采用 **A2A (Agent2Agent) 协议作为控制面**（发现、握手、任务状态与错误反馈），并采用**挂载式远程文件系统作为数据面**（实现远端智能体使用自身工具对目录的透明读写），通过**租约式（lease-based）会话**、**导出视图目录（export view）**、**远端挂载点回传**与**本地策略约束**，实现可控、可清理、可并发管理的多智能体远程协作。

## 2. 目标与非目标
### 2.1 目标（v1 必须达到）

1. **"像在自己电脑上工作"的体验**：远端智能体可使用其自身工具链（write/edit/各种 CLI）对 Host 指定目录进行读写，无需修改远端工具实现（通过挂载实现）。

2. **最小化本地 agent 的认知负担**：本地仅需 3 个 MCP 工具：
   - `delegate` 发起协作
   - `delegate_output` 获取/等待结果
   - `delegate_cancel` 取消协作

3. **基于 A2A 的互操作**：远端协作者是一个 A2A server；Host 通过 Agent Card 发现其支持 AWCP。

4. **远端机器安全可控**：远端必须基于其本地策略选择挂载点并回传（`mount_point`），避免 Host "随意让远端挂载到危险目录"。

5. **Host 暴露面最小化**：Host 不直接暴露真实路径；使用 export view directory 将 `local_dir` 映射为会话级导出目录，便于隔离、审计与清理。

6. **支持阻塞/非阻塞 + 多任务管理**：支持并发 delegate 并在全部完成时做一次聚合通知。

### 2.2 非目标（v1 不做/不承诺）

1. **开放互联网零信任协作**：v1 假设 peer URL 由用户显式配置（人为信任）。后续可增强身份验证、可衰减 token、信誉系统等。

2. **细粒度 POSIX 级权限**（如允许写但禁止 delete）：v1 只推荐支持 `ro`/`rw` 两档访问。更细粒度需要自定义 FS 层或隔离+合并策略，留作 v2。

3. **实时同文件 CRDT 协同编辑**：v1 用挂载+（可选）git 进行一致性管理；CRDT 属于未来可扩展方向。

4. **规定远端 agent 必须使用何种内部工具/框架**：AWCP 只要求其 A2A server 支持 AWCP 扩展消息与挂载执行。

## 3. 系统总体架构（对称安装 + 可选协作能力 + SDK/MCP 双形态）

Host/Remote 的安装与流程尽量对称，协作能力作为可配置选项，既可通过 MCP server 也可通过 SDK 集成。

### 3.1 安装分发形态

- **Python**：`pip install awcp`（占位名）
- **JS/TS**：`npm install @awcp/sdk`（占位名）

AWCP 提供两种集成层级：

1. **AWCP MCP Server**：给本地 agent 直接提供 `delegate/*` 工具（最快接入）
2. **AWCP SDK**：给开发者在自己的 A2A server 内更深度定制（例如自定义策略、审计、调度）

### 3.2 组件（逻辑角色）

在任何节点（Host 或 Remote），用户启动 A2A server 时可选择是否启用 AWCP 能力：

#### AWCP Daemon（可选，建议启用）

常驻管理服务，负责会话状态、目录导出、凭证、并发队列、日志与回收。它是后台"任务与会话管理器"。

#### AWCP A2A Extension（可选）

让该 A2A server 能作为：

- **协作者（Collaborator）**：接收 INVITE，挂载 Host workspace 并执行任务
- **委派者（Delegator）**（可选）：发起 INVITE 邀请别人协作（通常由 MCP/SDK 客户端实现）

#### AWCP MCP Tools（可选，通常只在委派者侧启用）

为本地 IDE/agent 暴露三个工具：`delegate`、`delegate_output`、`delegate_cancel`。

> **注意**：这三个工具是"委派者能力"，不是"协作者能力"；协作者能力在 A2A server extension 中。

**对称性体现在**：同一个包在任意节点都能启用/禁用这些能力；但在实际使用中，Host 通常启用 daemon + MCP tools，Remote 通常启用 A2A extension（协作者）+ 本地策略。

## 4. AWCP v1 的核心理念：租约式委派（Delegation Lease）+ 双边安全控制

AWCP 把一次协作视为一个 **Delegation Lease（委派租约）**：

- Lease 有唯一 `delegation_id`
- Lease 绑定：
  - `peer_url`（远端 A2A agent）
  - `local_dir`（Host 目录）
  - `export_view_dir`（Host 会话导出目录）
  - `ttl`
  - `access_mode`（ro/rw）
  - `remote_mount_point`（由 Remote 选择并回传）
- Lease 的生命周期与状态机由 daemon 管理，确保可清理与可追踪。

## 5. 数据面：挂载式远程文件系统（Mount Data Plane）

### 5.1 为什么挂载能实现"远端用自己的工具像本地一样工作"

远端智能体的工具（write、bash、各种编译器/格式化器/测试工具）只要对文件系统操作发生在挂载点目录下，就会通过 OS/VFS 层转发到 Host 导出目录。远端无需"替换/插拔自己的 write 工具实现"，因此认知负担最小。

### 5.2 传输与客户端选择（v1 的态度）

- AWCP v1 **不把** sshfs/webdav 暴露为每次工具调用参数，以降低复杂度。
- 由安装/配置决定默认 transport（建议优先 sshfs），失败时可降级或报错。
- 文档中要求用户安装挂载客户端与 git（如需要本地管理）。

## 6. 控制面：基于 A2A 的 AWCP 扩展

AWCP 使用 A2A 作为控制面，依赖：

- Agent Card 发现（`/.well-known/agent-card.json`）
- `message/send` / `message/stream` 或 REST/gRPC 传输
- A2A 的扩展机制：`capabilities.extensions[]` + message/data `metadata`

### 6.1 Agent Card 扩展声明

协作者（Remote）在 Agent Card 中声明支持 AWCP：

`capabilities.extensions` 增加：

- `uri`: `https://awcp-protocol.org/v1`（示例）
- `required`: `false`（可选）
- `params`: 可包含其支持的 transport、最大 TTL、是否支持只读等

这使得委派者可以在 discovery 时筛选"可协作"的 agent。

## 7. AWCP v1 协作流程（INVITE → ACCEPT → START → DONE/ERROR）
### 7.1 流程概览

1. **INVITE**（Host → Remote）：提出协作请求（不下发可用凭证），包含任务、TTL、访问模式等
2. **ACCEPT**（Remote → Host）：Remote 根据本地策略决定是否接受，并回传安全挂载点 `mount_point` 与约束
3. **START**（Host → Remote）：Host 在确认 Remote 已准备好后，创建 export view 与临时凭证，并下发可挂载的 endpoint + credential
4. **DONE / ERROR**（Remote → Host）：Remote 完成或失败，回传最终输出或错误；随后双方清理

### 7.2 关键安全点

- **Remote has final say on mount_point**：Remote 自选挂载目录，必须位于其本地策略允许的根目录下，并可要求为空目录。
- **Credentials released only after ACCEPT**：Host 只在 Remote ACCEPT 后才发放真正可用凭证，降低凭证泄露或"未准备好就挂载"的风险。
- **Remote sandbox is locally enforced**：Remote 用户决定协作时 agent 是否仅能在挂载目录下操作、是否允许 network/exec 等。

## 8. AWCP 消息与字段

所有消息通过 A2A `message/send`（或 `stream`）发送，内容放在一个 `DataPart`，例如：

```json
{
  "kind": "data",
  "data": {
    "awcp": {
      "version": "1",
      "type": "INVITE|ACCEPT|START|DONE|ERROR",
      ...
    }
  }
}
```

下面是每种消息的建议字段。

### 8.1 INVITE（Host → Remote）

**必选：**

- `version`: `"1"`
- `type`: `"INVITE"`
- `delegation_id`
- `task`：
  - `description`（短描述）
  - `prompt`（完整任务描述，含 expected outcome + must not）
- `lease`：
  - `ttl_seconds`
  - `access_mode`: `"ro"` | `"rw"`（v1 推荐只做两档）
- `workspace`：
  - `export_name`（逻辑名，不是真实路径；例如 `awcp/<id>`）
- `requirements`（用于远端预检）：
  - `needs_mount_client`: `true`
  - `mount_transport`: `"sshfs"`（可省略为默认）
  - `needs_git`: `optional`（v1 可不写）

**不建议在 INVITE 中包含：**

- 真实可用的 credential
- 真实系统路径

### 8.2 ACCEPT（Remote → Host）

**必选：**

- `type`: `"ACCEPT"`
- `delegation_id`
- `remote_mount`：
  - `mount_point`（Remote 本机路径）
  - `requires_empty_dir`: `true`/`false`

**建议：**

- `remote_constraints`：
  - `accepted_access_mode`（允许 Remote 将 rw 降级为 ro）
  - `max_ttl_seconds`（可能小于 host 提案）
  - `sandbox_profile`：
    - `cwd_only`: `true`/`false`
    - `allow_network`: `true`/`false`
    - `allow_exec`: `true`/`false`

### 8.3 START（Host → Remote）

**必选：**

- `type`: `"START"`
- `delegation_id`
- `lease`：
  - `expires_at`（或剩余 ttl）
  - `access_mode`（协商后的最终值）
- `mount`（可用的挂载信息）：
  - `transport`: `"sshfs"`（v1 默认）
  - `endpoint`: `{ host, port, user }`
  - `export_locator`: 例如 export path 或 token 化 locator
  - `credential`: 临时凭证（如临时 ssh key 或 token）
  - `mount_options`（可选）：如只读选项等

Host 收到 ACCEPT 后才创建：

- export view directory
- ephemeral credential 并在 START 中下发。

### 8.4 DONE（Remote → Host）

**必选：**

- `type`: `"DONE"`
- `delegation_id`
- `final_summary`（这是 `delegate_output` 返回的核心文本）

**可选：**

- `highlights`: 文件列表/建议查看的路径
- `notes`: 额外说明（例如"我做了哪些步骤"）

### 8.5 ERROR（任一方 → 对方）

**必选：**

- `type`: `"ERROR"`
- `delegation_id`
- `code`（枚举建议）：
  - `DECLINED`
  - `DEP_MISSING`（缺 sshfs 等）
  - `MOUNTPOINT_DENIED`（不符合 remote 本地策略）
  - `START_EXPIRED`（lease 过期）
  - `AUTH_FAILED`
  - `MOUNT_FAILED`
  - `TASK_FAILED`
  - `CANCELLED`
- `message`（人类可读）
- `hint`（修复建议）

## 9. Host 侧：导出视图目录（Export View Directory）

### 9.1 目的

- 避免暴露真实路径
- 会话级隔离与清理
- 可绑定临时凭证与访问范围
- 支持审计与回溯

### 9.2 目录结构建议

**导出目录**：`/var/AWCP/exports/<delegation_id>/`

- `workspace/` → 指向 `local_dir`（bind mount / symlink / worktree）
- `meta/` → 本次协作的只读元数据（如 task、peer_url、start/end time）

**委派记录目录**：`~/.AWCP/delegations/<delegation_id>/`

- `status.json`
- `result.json`（DONE/ERROR 内容）
- `logs/`（daemon 日志片段，可选）
- `audit.jsonl`（审计事件流，可选）

## 10. MCP 工具规范（3 个）

### 10.1 `delegate`

**用途**：发起一次远程协作委派。

**参数**：

| 参数 | 类型 | 必选 | 说明 |
|------|------|------|------|
| `description` | string | ✓ | 3–5 words 简短描述 |
| `prompt` | string | ✓ | 任务说明，建议包含 MUST DO / MUST NOT / EXPECTED OUTPUT |
| `peer_url` | string | ✓ | 目标远端 A2A agent URL |
| `workspace_dir` | string | ✓ | 本地目录 |
| `background` | boolean | | 默认 `false`；`true` 表示异步 |
| `ttl_seconds` | number | | 可选，有默认值 |
| `access_mode` | `"ro"` \| `"rw"` | | 可选，有默认值 |

**返回**：

- 若 `background=false`：等待 DONE/ERROR 后返回最终输出（同时包含 `<AWCP_metadata>`）
- 若 `background=true`：立即返回 `delegation_id`，并说明"用 `delegate_output` 获取结果"

**建议输出结构**（对齐现有工具风格）：

```json
{
  "output": "人类可读文本（类似 TaskTool）",
  "metadata": {
    "delegation_id": "...",
    "status": "...",
    "session_id": "...",
    "peer_url": "..."
  }
}
```

### 10.2 `delegate_output`

**用途**：查询或等待某个 delegation 的输出。

**参数**：

| 参数 | 类型 | 必选 | 说明 |
|------|------|------|------|
| `delegation_id` | string | ✓ | 委派 ID |
| `block` | boolean | | 是否等待完成 |
| `timeout` | number | | 超时时间（秒） |

**返回**：

- 如果 `running`：返回当前状态 + 已知进度摘要（如果 A2A streaming 有）
- 如果 `completed`/`error`：返回远端 `final_summary` 或 error 信息 + 本地补充（变更目录、结束时间等）

### 10.3 `delegate_cancel`

**用途**：取消某个 delegation（或取消当前 session 下所有）。

**参数**：

| 参数 | 类型 | 必选 | 说明 |
|------|------|------|------|
| `delegation_id` | string | | 指定要取消的委派 |
| `all` | boolean | | 取消所有 |

**语义**：

1. Daemon 将状态置为 `cancelled`
2. 通过 A2A 发取消请求（实现可用 A2A `tasks/cancel` 或发送 AWCP `ERROR/CANCELLED`）
3. 强制清理 export view + 回收凭证（best-effort）

## 11. Daemon：任务/租约管理模型

### 11.1 状态机

```
created → invited → accepted → started → running → completed
                                    ↓           ↓
                                  error ←───────┤
                                    ↑           ↓
                              cancelled ←── expired
```

| 状态 | 说明 |
|------|------|
| `created` | 初始状态 |
| `invited` | INVITE 已发出 |
| `accepted` | 收到 ACCEPT |
| `started` | START 已发出 |
| `running` | Remote 已挂载并执行；可由 remote 回报或由任务状态推断 |
| `completed` | 收到 DONE |
| `error` | 收到 ERROR |
| `cancelled` | 本地取消 |
| `expired` | TTL 到期 |

### 11.2 并发与队列

- 支持按 `peer_url` 或按 `workspace_dir` 做并发限流
- 同一 `workspace_dir` 默认建议互斥（避免两个远端同时改同一目录，v1 先简单）

### 11.3 "全部完成提醒"

对齐 Cortex 的 `notifyParentSession` 思路：

1. Daemon 维护 `pendingByParentSession`（MCP ctx 可提供 parent session id）
2. 每个 delegation 完成后，若该 parent session 下无 pending：触发一次聚合通知（synthetic reminder）

**具体如何"唤醒 host agent"取决于宿主**：

- 若掌控对话系统（像 `SessionPrompt.prompt` 支持 synthetic），可注入
- 若在第三方 IDE，通常只能通过用户/agent 后续调用 `delegate_output` 获取（仍可在 daemon 层打印/系统通知）

## 12. Remote 侧安全：本地策略

Remote 必须有本地策略文件/配置（由 Remote 用户设置），示例能力：

| 策略项 | 说明 |
|--------|------|
| 允许的挂载根目录 | 例如 `/AWCP/mounts/**` |
| 是否要求挂载点为空目录 | 防止覆盖已有文件 |
| 最大 TTL | 限制单次协作时长 |
| 允许的 `access_mode` | 是否允许 `rw` |
| 协作 sandbox 配置 | 见下 |

**Sandbox 选项**：

- `cwd_only`：只允许工具在 `mount_point` 下运行（实现方式由 remote 自己决定：容器、chroot、进程策略等）
- `allow_network`：是否允许网络访问
- `allow_exec`：是否允许执行外部命令

> **注意**：v1 协议不强制规定 remote 的 sandbox 如何实现，但要求 remote 在 ACCEPT 里声明其 `sandbox_profile`，便于审计与调试。

## 13. 取消与回收

### 13.1 Host 发起取消（`delegate_cancel`）

1. 立即回收 export view / 凭证（防止继续写入）
2. 向 Remote 发送取消信号（best-effort）

### 13.2 TTL 到期

1. Daemon 自动回收 export view / 凭证
2. 标记状态为 `expired`
3. 向 Remote 发送 `ERROR`（`START_EXPIRED` 或 `EXPIRED`）

### 13.3 Remote 应对

如果写入过程中突然失效，会得到 I/O 错误；remote extension 应捕获并返回 `ERROR`（`TASK_FAILED`/`EXPIRED`）给 Host。

## 14. v1 的可选增强：git 管理（不进入协议核心）

可以在 daemon 内部做"可选 git 管理"，但不进入协议交互字段：

**自动初始化**：
- 若 `workspace_dir` 非 git repo：可选自动 `git init` + baseline commit

**Delegation 完成后输出**：
- `changed_paths`：变更的文件路径列表
- `diff_stat`：变更统计
- （可选）自动 commit（由 host 配置决定）

> 这不会影响 remote "像本地一样工作"，只是 host 侧更好审计与回滚。

## 15. 已知局限与 v2 方向

| 局限 | v2 可能方向 |
|------|-------------|
| **细粒度权限**（禁止 delete、限制文件类型） | 自定义 FS 层或隔离+合并策略 |
| **零信任/开放互联网协作** | 身份验证（DID/证书 pinning）、可衰减 token（macaroons 思路）、审计签名 |
| **多协作者同时改同目录** | worktree/分支策略或 CRDT 文档层 |
| **远端 sandbox 标准化** | 可移植的 sandbox profile 与合规测试 |